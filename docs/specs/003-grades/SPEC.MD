# SPEC 003 â€” SystÃ¨me de grades et rÃ´les
### Ã€ lire entiÃ¨rement avant de coder quoi que ce soit

---

## Contexte

Nexus a deux niveaux de rÃ´les :

1. **RÃ´les systÃ¨me** â€” fixes, dÃ©finis par Nexus
2. **Grades personnalisÃ©s** â€” crÃ©Ã©s par les admins de chaque communautÃ©

Un utilisateur peut avoir un rÃ´le systÃ¨me ET un grade personnalisÃ©.
Le grade personnalisÃ© s'affiche en prioritÃ© dans le ProfileCard.

---

## Niveau 1 â€” RÃ´les systÃ¨me

DÃ©jÃ  en place dans `community_members.role` :
```
owner       â†’ CrÃ©ateur, droits absolus, ne peut pas Ãªtre retirÃ©
admin       â†’ Droits complets sauf supprimer la communautÃ©
moderator   â†’ Peut modÃ©rer posts et threads
member      â†’ Membre standard
```

Ces rÃ´les ne sont PAS renommables. Ils sont internes Ã  Nexus.

---

## Niveau 2 â€” Grades personnalisÃ©s

CrÃ©Ã©s librement par les admins d'une communautÃ©.
Exemples :
```
CommunautÃ© Linux     â†’ "Kernel Master", "Contributeur", "Padawan"
CommunautÃ© Photo     â†’ "Photographe Pro", "Amateur", "Curieux"
CommunautÃ© Gaming    â†’ "Grand MaÃ®tre", "Joueur", "Noob"
```

---

## Ã‰tape 1 â€” Base de donnÃ©es

Fichier : `nexus-core/src/migrations/003_grades.sql`

```sql
-- Grades personnalisÃ©s par communautÃ©
CREATE TABLE community_grades (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  community_id UUID REFERENCES communities(id) ON DELETE CASCADE,
  name         VARCHAR(100) NOT NULL,
  color        VARCHAR(7) DEFAULT '#99AAB5',  -- hex color
  position     INTEGER DEFAULT 0,             -- ordre d'affichage
  permissions  JSONB DEFAULT '{}',            -- droits associÃ©s
  created_at   TIMESTAMP DEFAULT NOW()
);

-- Grade attribuÃ© Ã  un membre
ALTER TABLE community_members
ADD COLUMN grade_id UUID REFERENCES community_grades(id) ON DELETE SET NULL;

-- Index
CREATE INDEX idx_grades_community ON community_grades(community_id);
CREATE INDEX idx_members_grade ON community_members(grade_id);
```

Format du champ `permissions` (JSONB) :
```json
{
  "can_post": true,
  "can_create_thread": true,
  "can_create_category": false,
  "can_moderate": false,
  "can_manage_members": false,
  "can_manage_grades": false
}
```

---

## Ã‰tape 2 â€” Backend API

### Routes grades (admin uniquement)

```
GET    /api/v1/communities/:slug/grades
â†’ Liste tous les grades de la communautÃ©

POST   /api/v1/communities/:slug/grades
â†’ CrÃ©er un grade
â†’ Body: { name, color, position, permissions }

PATCH  /api/v1/communities/:slug/grades/:id
â†’ Modifier un grade (nom, couleur, permissions)

DELETE /api/v1/communities/:slug/grades/:id
â†’ Supprimer un grade (les membres perdent ce grade)

PATCH  /api/v1/communities/:slug/members/:userId/grade
â†’ Attribuer ou retirer un grade Ã  un membre
â†’ Body: { grade_id } ou { grade_id: null }
```

### Middleware de permissions
CrÃ©er `src/middleware/permissions.ts` :
```typescript
// VÃ©rifie si l'utilisateur a la permission requise
// dans la communautÃ© donnÃ©e
checkPermission(permission: keyof Permissions)
```

---

## Ã‰tape 3 â€” Mise Ã  jour ProfileCard

Fichier : `nexus-frontend/src/lib/components/ProfileCard.svelte`

Ajouter sous le username :
```
[Avatar]
Username
[Badge grade colorÃ©]   â† NOUVEAU
â­ Points
#tags
```

Le badge grade :
- Couleur de fond = `grade.color`
- Texte blanc ou noir selon la luminositÃ©
- Absent si pas de grade attribuÃ©

---

## Ã‰tape 4 â€” Interface d'administration des grades

Fichier : `nexus-frontend/src/routes/communities/[slug]/admin/grades/+page.svelte`

Interface simple :
```
Grades de la communautÃ©

[+ CrÃ©er un grade]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nom             â”‚ Couleur  â”‚ Permissions         â”‚ Actions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Kernel Master   â”‚ ðŸ”´ rouge â”‚ modÃ©ration + posts  â”‚ âœï¸ ðŸ—‘ï¸   â”‚
â”‚ Contributeur    â”‚ ðŸŸ  orangeâ”‚ posts + threads     â”‚ âœï¸ ðŸ—‘ï¸   â”‚
â”‚ Padawan         â”‚ ðŸŸ¢ vert  â”‚ posts seulement     â”‚ âœï¸ ðŸ—‘ï¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Accessible uniquement aux owner et admin.

---

## Ordre d'exÃ©cution OBLIGATOIRE

```
1. Migration SQL 003_grades.sql
2. Appliquer la migration en base
3. Routes backend grades CRUD
4. Middleware permissions
5. Mise Ã  jour ProfileCard avec badge grade
6. Page admin/grades
7. Commit aprÃ¨s chaque Ã©tape
```

---

## Ce qu'on ne fait PAS dans cette spec

- Interface d'attribution des grades par membre â†’ Phase suivante
- Grades globaux Nexus (hors communautÃ©) â†’ Phase 2
- HiÃ©rarchie de grades hÃ©ritÃ©e â†’ Phase 2

---

*"Simple > Complexe. Toujours."*