version: '3.9'

# ── Nexus — Full stack ────────────────────────────────────────────────────────
#
# Usage:
#   1. cp .env.example .env                     ← set DB_PASSWORD
#   2. cp nexus-core/.env.example nexus-core/.env    ← configure your community
#   3. cp nexus-frontend/.env.example nexus-frontend/.env
#   4. docker-compose up -d
#
# Reverse proxy (nginx / Caddy) must forward:
#   /api/  and /uploads/ and /socket.io/  →  http://localhost:3000
#   /                                     →  http://localhost:3001
#
# See Caddyfile.example for a ready-to-use Caddy configuration.

services:

  # ── PostgreSQL 16 ────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       nexus
      POSTGRES_USER:     nexus_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in your .env file}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:     ["CMD-SHELL", "pg_isready -U nexus_user -d nexus"]
      interval: 5s
      timeout:  5s
      retries:  10

  # ── Redis 7 ──────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

  # ── Nexus API (Fastify + TypeScript) ─────────────────────────────────────────
  api:
    build: ./nexus-core
    restart: unless-stopped
    env_file: ./nexus-core/.env
    environment:
      # These override values in nexus-core/.env to use Docker service names
      DB_HOST:     postgres
      DB_PORT:     "5432"
      DB_NAME:     nexus
      DB_USER:     nexus_user
      DB_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in your .env file}
      REDIS_HOST:  redis
      REDIS_PORT:  "6379"
    ports:
      - "3000:3000"
    volumes:
      - ./nexus-core/uploads:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # ── Nexus Frontend (SvelteKit) ────────────────────────────────────────────────
  frontend:
    build: ./nexus-frontend
    restart: unless-stopped
    env_file: ./nexus-frontend/.env
    ports:
      - "3001:3001"
    depends_on:
      - api

volumes:
  postgres_data:
  redis_data:
